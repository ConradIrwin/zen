<div class='mini'>
  {#if statusText}
    <div class='statusText'>{statusText}</div>
  {:else}
    <div class='runDetails'>
      <div class='failureGroups'>
        {#each $failureGroups.slice(0, 17) as group}
          <span class='failureGroup shade-{group.shade} {group.containsFocus ? "containsFocus" : ""}' on:click='$focusGroup(group)' title={group.key}></span>
        {/each}
      </div>
      <span class='progress'>{$results.length}/{$totalCount}</span>
    </div>

    {#if $focus}
    <div class='focusDetails'>
      <button class='focusStatus {$focusStatus}' on:click='$run({focusOnly: true})' title='Run the focused test [alt-space]'></button>
      <span>{$focus}</span>
    </div>
    {/if}

    {#if $groupForFocus}
    <div class='groupDetails'>
      <div class='error'>{$groupForFocus.key}</div>
      {#if $groupForFocus == expandedGroup}
        {#each $groupForFocus as result}
          <a href='javascript:void(0)' on:click='$run({focus: result.fullName, batch: null})' class='fail'>{result.fullName}</a>
        {/each}
      {:elseif $groupForFocus.length > 1}
        <a href='javascript:void(0)' on:click='set({expandedGroup: $groupForFocus})'>{$groupForFocus.length - 1} more</a>
      {/if}
    </div>
    {/if}
  {/if}
</div>

<style>
  .mini {
    all: initial;
    position: fixed;
    bottom: 0; width: 400px; left: 50%;
    margin-left: -200px;
    padding: 8px 5px;
    border: 1px solid #ddd;
    background: #fff;
    font-size: 10px;
    font-family: 'Lucida Sans', 'Lucida Sans Regular', 'Lucida Grande', 'Lucida Sans Unicode', Geneva, Verdana, sans-serif;
    z-index: 9999;
    display: flex;
    flex-direction: column-reverse;
    overflow: hidden;
  }

  .mini > div { padding-top: 8px; }
  .mini > div:last-child { padding-top: 0; }

  .runDetails { display: flex; }
  .runDetails .progress { margin-left: 5px; }
  .runDetails .failureGroups { flex: 1; }

  .failureGroup {
    display: inline-block;
    width: 11px; height: 11px;
    border-radius: 50%;
    margin-right: 3px;
    cursor: pointer;
    position: relative; /* for :after */
  }
  .failureGroup.shade-1 { background-color: rgba(128, 0, 0, 0.3); }
  .failureGroup.shade-2 { background-color: rgba(128, 0, 0, 0.5); }
  .failureGroup.shade-3 { background-color: rgba(128, 0, 0, 0.7); }
  .failureGroup.shade-4 { background-color: rgba(128, 0, 0, 0.9); }
  .failureGroup.shade-5 { background-color: rgba(128, 0, 0, 1.0); }

  .failureGroup.containsFocus:after {
    content: '';
    width: 11px; height: 0;
    border-top: 1px solid #8a6a6a;
    display: block;
    position: relative;
    bottom: -13px;
  }

  .focusDetails { display: flex; }
  .focusStatus {
    flex: 0 0 11px; height: 11px;
    border-radius: 50%;
    border: 1px solid #ddd;
    margin-right: 5px;
  }
  .focusStatus.none { display: none; }
  .focusStatus.passed { background-color: green; }

  .groupDetails {
    /* word-wrap: break-word; */
    padding-left: 16px;
  }
  .groupDetails a {
    display: block;
    margin-top: 5px;
    color: maroon;
    font-size: 10px;
  }
</style>

<script>
export default {
  computed: {
    statusText: function statusText({$socketDisconnected, $results, $compile, $s3, $totalCount, $lambdaCount}) {
      if  ($socketDisconnected)
        return 'Disconnected (check server and reload)'

      if ($compile.status == 'error')
        return 'Compile error ' + $compile.errors.join(' ')

      if ($compile.status == 'compiling')
        return 'Compiling'

      if ($lambdaCount && $results.length == 0)
        return `Starting ${$lambdaCount} workers`

      if ($s3 && !$s3.done && $s3.changed)
        return `Uploading ${$s3.uploaded}/${$s3.changed}`

      return ''
    }
  }
}
</script>
