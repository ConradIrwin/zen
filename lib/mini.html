<div class='mini'>
  {{results.length}}/{{totalCount}}
  {{#each fails as f}}
    <a href={{testUrl(f)}} on:click='fastChange(event)' class='fail'>{{f.fullName}}</a>
  {{/each}}
  {{#if fails.length > 0}}
    <button on:click='fastChange()'>&gt;</button>
  {{/if}}
  <button on:click='run(true)'>R</button>
</div>

<style>
  .mini {
    position: fixed;
    top: 0; width: 300px; left: 50%;
    margin-left: -150px;
    padding: 10px;
    border: 1px solid #ddd;
  }

  .fail {
    color: maroon;
    font: 10px;
  }
</style>

<script>
  function oncreate() {
    this.ws = new WebSocket(`ws://${location.host}/head`)
    this.ws.onmessage = (msg) => {
      let data = JSON.parse(msg.data)

      if (data.results)
        this.set({results: this.get('results').concat(data.results)})

      if (data.codeHash && ZenWebpackClient.needsUpdate(data.codeHash))
        this.updateCode(data.codeHash)
    }
    this.ws.onopen = this.run.bind(this, false)
    window.onpopstate = this.run.bind(this, false)
  }

  function run(force) {
    let params = new URLSearchParams(location.search)
    let grep = params.get('grep') && new RegExp(params.get('grep'), 'i')
    let focus = params.get('focus') && new RegExp(params.get('focus'), 'i')
    let tests = Latte.flatten().filter(t => !grep || grep.test(t.fullName))

    this.testsByName = {}
    tests.forEach(t => this.testsByName[t.fullName] = t)

    // tell workers what to do
    this.ws.send(JSON.stringify({grep: params.get('grep') || '', force}))

    if (focus) { // if we're focused, run those tests
      let focused = tests.filter(t => focus.test(t.fullName))
      Latte.run({mode: 'debug', tests})
    }

    this.set({results: [], totalCount: tests.length})
  }

  async function updateCode(hash) {
    this.mostRecentHash = hash
    if (this.updating) return
    this.updating = true

    await Latte.abort()
    while(ZenWebpackClient.needsUpdate(this.mostRecentHash))
      await ZenWebpackClient.update()
    this.updating = false

    this.run()
  }

  // handle link clicks without reloading
  function fastChange(event) {
    history.pushState({}, 'Zen', event.target.getAttribute('href'))
    event.preventDefault()
    this.run()
  }

  function testUrl(result) {
    let sp = new URLSearchParams(location.search)
    sp.set('focus', result.fullName)
    return '?' + sp.toString()
  }

  export default {
    data: () => ({results: [], totalCount: 0}),
    oncreate,

    computed: {
      fails: results => results.filter(t => t.error)
    },

    helpers: {testUrl},
    methods: {fastChange, run, updateCode}
  }
</script>
